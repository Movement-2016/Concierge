#!/bin/sh
echo "fetching last commit...."
commitId=`git log -1 | grep "commit" | sed 's/commit //'`
echo "deploying commit $commitId..."
deploymentId=`aws deploy create-deployment --application-name MovementVoteApp --deployment-group-name MovementVoteDeployGrp --github-location commitId=$commitId,repository=Movement-2016/concierge | egrep -o 'd-[A-Z0-9]+'`
echo "...done (deploymentId: $deploymentId)"
echo "#!/bin/sh" > dist/deploy-status
echo "result=\"aws deploy get-deployment --deployment-id $deploymentId\"" >> dist/deploy-status
echo "[[ \"\$1\" == \"-v\" ]] && \$result || \$result | egrep -o '\"status\": [^,]+'" >> dist/deploy-status
chmod a+x dist/deploy-status
echo "#!/bin/sh" > dist/deploy-stop
echo "aws deploy stop-deployment --deployment-id $deploymentId" >> dist/deploy-stop
chmod a+x dist/deploy-stop
echo "run 'dist/deploy-status [-v]' or 'dist/deploy-stop"
