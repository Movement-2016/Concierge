#!/bin/sh
#
##
## Steps for new EC2 instance
## This should be attached as "user-data" to EC2 instances
##
#
sudo yum -y update
#
#########################
# code deploy agent
#########################
mkdir codedeploy
cd codedeploy
wget https://aws-codedeploy-us-west-2.s3.amazonaws.com/latest/install
chmod +x ./install
sudo ./install auto
#
##############################
# files we don't want in git
##############################
aws s3 sync s3://gamechangerlabs/movement-vote-install $HOME/
#
##############################
# git and repo
##############################
sudo yum -y install git
git clone https://github.com/Movement-2016/concierge.git $HOME/concierge
#
##############################
# nvm and node
##############################
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash
. $HOME/.bashrc
nvm install v6
#
##############################
# install and start our app
##############################
sh $HOME/concierge/stage/after-install.sh
sh $HOME/concierge/stage/app-start.sh
#
##############################
# nat tables port munge
##############################
sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 3000
sudo iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 4000
#
##############################
# let's encrypt
##############################
cd $HOME/certbot
wget https://dl.eff.org/certbot-auto
chmod a+x certbot-auto
chmod a+x _renew-script
